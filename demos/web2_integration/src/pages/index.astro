---
import Layout from "../layouts/Layout.astro";
---

<Layout title="VC test app">
  <main id="pageContent" aria-live="polite"></main>

  <script>
    import { html } from "lit-html";
    import { AuthClient } from "@dfinity/auth-client";
    import { nonNullish, isNullish } from "@dfinity/utils";
    import { asyncReplace } from "lit-html/directives/async-replace.js";
    import { createRef, ref } from "lit-html/directives/ref.js";
    import { decodeJwt } from "jose";
    import { Chan, renderPage, withRef } from "../utils";

    const latestPres = new Chan<string | undefined>(undefined);
    const ii = new Chan<
      { win: Window; origin: string; flowId: number } | undefined
    >(undefined);
    const evntHandler = (evnt: MessageEvent) => {
      console.log(
        `Got:
        ${JSON.stringify(evnt.data, (_key, value) =>
          typeof value === "bigint" ? value.toString() : value,
        )}`,
      );

      if (evnt.data?.method === "vc-flow-ready" && nonNullish(ii.latest)) {
        const principal = withRef(principalInput, (principalInput) => {
          const value = principalInput.innerText;
          if (value === "") {
            return undefined;
          }

          return value;
        });

        if (isNullish(principal)) {
          alert("No principal set; cannot send request ");
          return;
        }

        const issuerOrigin = withRef(issuerInput, (issuerInput) => {
          const value = issuerInput.value;
          if (value === "") {
            return undefined;
          }

          return value;
        });
        if (isNullish(issuerOrigin)) {
          alert("No issuer set; cannot send request ");
          return;
        }

        const credentialSpecs = {
          employee: {
            credentialType: "VerifiedEmployee",
            arguments: { employerName: "DFINITY Foundation" },
          },
          grad: {
            credentialType: "UniversityDegreeCredential",
            arguments: { institutionName: "DFINITY College of Engineering" },
          },
        };

        let message = {
          id: ii.latest.flowId,
          jsonrpc: "2.0",
          method: "request_credential",
          params: {
            issuer: {
              origin: issuerOrigin,
            },
            credentialSpec: credentialSpecs[credentialType.latest],
            credentialSubject: principal,
          },
        };

        console.log(`message: ${JSON.stringify(message)}`);
        ii.latest?.win.postMessage(message, ii.latest.origin);
      }

      const verifiablePresentation = evnt.data?.result?.verifiablePresentation;
      if (nonNullish(verifiablePresentation)) {
        const ver = decodeJwt(verifiablePresentation) as any;
        const creds = ver.vp.verifiableCredential;

        const pretty = creds.map((cred: string) =>
          JSON.stringify(decodeJwt(cred), null, 2),
        );
        latestPres.send("[" + pretty.join(",") + "]");

        ii.latest?.win?.close();
      }
    };

    // TODO: we should wait for ready
    window.addEventListener("message", evntHandler);
    const nextId = new Chan<number>(0);
    const urlInput = createRef<HTMLInputElement>();
    const issuerInput = createRef<HTMLInputElement>();
    const principalInput = createRef<HTMLInputElement>();
    const credentialType = new Chan<"grad" | "employee">("employee");
    const credentialSelection = (exp: "grad" | "employee") =>
      asyncReplace(
        credentialType.map((ty) => (ty === exp ? "c-button--selected" : "")),
      );

    const template = () => {
      return html`
        <div class="l-wrap" data-page-name="vc-test-app">
        <section class="l-container l-stack">
          <hgroup>
            <h1 class="t-title">Relying Party</h1>
          </hgroup>
          <div
            ${ref(principalInput)}
            data-role="principal"
            class="c-input c-input--stack c-input--fullwidth c-input--readonly t-vip--small"
          ></div>
          <button
            class="c-button"
            data-action="authenticate"
            @click=${async () => {
              const authClient = await AuthClient.create();

              const iiUrl = withRef(urlInput, (i) => i.value);

              const loginOptions: Parameters<typeof authClient.login>[0] = {
                identityProvider: iiUrl,
                onSuccess: () => {
                  withRef(principalInput, (principalInput) => {
                    principalInput.innerText = authClient
                      .getIdentity()
                      .getPrincipal()
                      .toString();
                  });
                },
                onError: (e) => {
                  alert(e ?? "Unknown error");
                },
              };

              authClient.login(loginOptions);
            }}
            >Login / Link Internet Identity</button>
            </section>
            <section class="l-container l-stack">
            <hgroup>
            <h1 class="t-title">Identity Provider</h1>
          </hgroup>
          <input
          ${ref(urlInput)}
          data-role="ii-url"
        class="c-input c-input--stack c-input--fullwidth"
        value="https://fgte5-ciaaa-aaaad-aaatq-cai.ic0.app"
          ></input>
          </section>
          <section class="l-container l-stack">
          <hgroup>
            <h1 class="t-title">Issuer</h1>
          </hgroup>
          <input
          ${ref(issuerInput)}
          data-role="issuer-url"
        class="c-input c-input--stack c-input--fullwidth"
        value="https://v2yvn-myaaa-aaaad-aad4q-cai.icp0.io"
          ></input>
          </section>
          <div class="c-button-group l-stack">
          <div @click=${() => {
            credentialType.send("employee");
          }} class="c-button c-button--secondary ${credentialSelection(
            "employee",
          )}">
          Employee
          </div>
          <div @click=${() => {
            credentialType.send("grad");
          }} class="c-button c-button--secondary ${credentialSelection(
            "grad",
          )}">
          Graduate
          </div>
          </div>
          <div class="c-button-group l-stack">
          <button
            data-role="start-vc-flow"
            class="c-button l-stack"
            @click=${() => {
              const urlRaw = withRef(urlInput, (urlInput) => urlInput.value);
              if (isNullish(urlRaw)) {
                alert("Could not read URL");
                return;
              }

              const urlParsed = new URL(urlRaw);
              urlParsed.pathname = "vc-flow/";

              const iiWindow = window.open(urlParsed.toString());
              if (isNullish(iiWindow)) {
                alert("Could not open window");
                return;
              }

              const flowId = nextId.latest;
              ii.send({ win: iiWindow, origin: urlParsed.toString(), flowId });

              nextId.send(flowId + 1);
            }}
          >
            Verify Credential
          </button>
          </div>
          ${asyncReplace(
            latestPres.map((latestPres) =>
              isNullish(latestPres)
                ? undefined
                : html`
                    <aside
                      style="max-width: 100%;"
                      class="l-stack c-card c-card--narrow"
                    >
                      <pre>    ${latestPres}</pre>
                    </aside>
                  `,
            ),
          )}
        </div>
      `;
    };

    const page = renderPage(template);

    page(undefined);
    withRef(principalInput, (principalInput) => {
      principalInput.innerText = "Not signed In";
      console.log("set anonymous");
    });
  </script>
</Layout>
