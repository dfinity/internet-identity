name: 'bootstrap'
description: Bootstrap the Internet Identity build environment
runs:
  using: "composite"
  steps:
    - id: uname
      shell: bash
      run: |
        # print include system info relevant for cache compatibility
        uname="$(uname -mpsr)"
        echo "uname value: $uname"
        uname_hash="$(echo "$uname" | shasum -a 256 | head -c 10)"
        echo "uname hash value: $uname_hash"
        echo "::set-output name=uname-hash::$uname_hash"

    # cache ic-cdk-optimizer
    # NOTE: here we make sure to only cache ic-cdk-optimizer and _not_ e.g. the cargo target, since in some cases
    # (clean builds) we build from scratch
    # NOTE: we include the output of uname to ensure binary compatibility (e.g. same glibc)
    - uses: actions/cache@v2
      with:
        path: ~/.cargo/bin
        key: cargo-bin-${{ hashFiles('**/Cargo.lock', 'rust-toolchain.toml') }}-${{ steps.uname.outputs.uname-hash }}

    - name: Bootstrap
      shell: bash
      run: ./scripts/bootstrap
