#!/usr/bin/env bash
# vim: ft=bash
# Build internet_identity.wasm inside docker. This outputs a single file, internet_identity.wasm,
# in the top-level directory.

set -euo pipefail

SCRIPTS_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

cd "$SCRIPTS_DIR/.."

echo "PWD: $PWD"

image_name="internet-identity"
docker_build_args=( --target scratch )

II_FETCH_ROOT_KEY=${II_FETCH_ROOT_KEY:-}
echo "II_FETCH_ROOT_KEY: '$II_FETCH_ROOT_KEY'"

if [[ "$II_FETCH_ROOT_KEY" == "1" ]]
then
    docker_build_args+=( --build-arg II_FETCH_ROOT_KEY="$II_FETCH_ROOT_KEY" )
    image_name="$image_name-fetchrootkey"
fi

II_DUMMY_CAPTCHA=${II_DUMMY_CAPTCHA:-}
echo "II_DUMMY_CAPTCHA: '$II_DUMMY_CAPTCHA'"

if [[ "$II_DUMMY_CAPTCHA" == "1" ]]
then
    docker_build_args+=( --build-arg II_DUMMY_CAPTCHA="$II_DUMMY_CAPTCHA" )
    image_name="$image_name-dummycaptcha"
fi

II_DUMMY_AUTH=${II_DUMMY_AUTH:-}
echo "II_DUMMY_AUTH: '$II_DUMMY_AUTH'"

if [[ "$II_DUMMY_AUTH" == "1" ]]
then
    docker_build_args+=( --build-arg II_DUMMY_AUTH="$II_DUMMY_AUTH" )
    image_name="$image_name-dummyauth"
fi

docker_build_args+=(--tag "$image_name" .)

echo "The following image name will be used: $image_name"

tmp_outdir=$(mktemp -d)

set -x
DOCKER_BUILDKIT=1 docker build "${docker_build_args[@]}" --output "$tmp_outdir"
set +x

echo "Copying build output from $tmp_outdir to $PWD"
cp "$tmp_outdir/internet_identity.wasm" .

echo "Removing $tmp_outdir"
rm -rf "$tmp_outdir"
